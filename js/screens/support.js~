window.SupportScreen = {
    isVisible: false,
    modal: null,
    currentView: 'main',
    currentFAQ: null,

    async show(params = {}) {
        this.isVisible = true;

        // Закрываем предыдущий модаль если есть
        if (this.modal) {
            this.hide();
        }

        this.modal = this.createModal();
        document.body.appendChild(this.modal);

        setTimeout(() => {
            this.modal.classList.add('active');
        }, 10);

        this.render();
        this.setupEventListeners();

        // Вибрация открытия
        if (window.TelegramApp) {
            window.TelegramApp.haptic.light();
        }
    },

    createModal() {
        return Utils.createElement('div', {
            id: 'supportModal',
            className: 'modal-overlay'
        });
    },

    render() {
        if (!this.modal) return;

        this.modal.innerHTML = `
            <div class="modal modal-support">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-headset"></i>
                        Поддержка
                    </div>
                    <button class="modal-close" id="supportClose">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- FAQ -->
                    <div class="faq-list">
                        <div class="faq-item" data-faq="connection">
                            <i class="fas fa-wifi"></i>
                            <span>Проблемы с подключением</span>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="faq-item" data-faq="speed">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Низкая скорость</span>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="faq-item" data-faq="setup">
                            <i class="fas fa-cog"></i>
                            <span>Настройка приложения</span>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="faq-item" data-faq="billing">
                            <i class="fas fa-credit-card"></i>
                            <span>Вопросы по оплате</span>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="supportCancel">Закрыть</button>
                    <button class="btn btn-primary" id="contactTechSupport">
                        <i class="fas fa-paper-plane"></i>
                        Написать в поддержку
                    </button>
                </div>
            </div>
        `;

        this.setupEventListeners();
    },

    setupEventListeners() {
        if (!this.modal) return;

        // Закрытие модального окна
        const closeBtn = this.modal.querySelector('#supportClose');
        const cancelBtn = this.modal.querySelector('#supportCancel');

        if (closeBtn) {
            closeBtn.addEventListener('click', () => this.hide());
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => this.hide());
        }

        // Переход в тех поддержку
        const techSupportBtn = this.modal.querySelector('#contactTechSupport');
        if (techSupportBtn) {
            techSupportBtn.addEventListener('click', () => this.contactTechSupport());
        }

        // FAQ
        const faqItems = this.modal.querySelectorAll('.faq-item');
        faqItems.forEach(item => {
            item.addEventListener('click', () => {
                const faqType = item.dataset.faq;
                this.showFAQ(faqType);
            });
        });

        // Закрытие по клику вне модала
        this.modal.addEventListener('click', (e) => {
            if (e.target === this.modal) {
                this.hide();
            }
        });

        // Закрытие по Escape
        document.addEventListener('keydown', this.handleEscapeKey.bind(this));
    },

    contactTechSupport() {
        // Переходим в Telegram
        const telegramUrl = 'https://t.me/dragonvpn_support';

        if (window.TelegramApp) {
            window.TelegramApp.openTelegramLink(telegramUrl);
        } else {
            window.open(telegramUrl, '_blank');
        }

        // Закрываем модальное окно
        this.hide();
    },

    showFAQ(type) {
        const faqContent = this.getFAQContent(type);

        if (window.TelegramApp) {
            window.TelegramApp.showAlert(`${faqContent.title}\n\n${faqContent.content}`);
        } else {
            // Fallback для браузера
            alert(`${faqContent.title}\n\n${faqContent.content}`);
        }

        // Вибрация при показе FAQ
        if (window.TelegramApp) {
            window.TelegramApp.haptic.light();
        }
    },

    getFAQContent(type) {
        const faqs = {
            connection: {
                title: 'Проблемы с подключением',
                content: `1. Проверьте интернет соединение\n2. Перезапустите VPN приложение\n3. Попробуйте другой сервер\n4. Проверьте настройки брандмауэра`
            },
            speed: {
                title: 'Низкая скорость',
                content: `1. Выберите ближайший сервер\n2. Смените протокол\n3. Закройте лишние приложения\n4. Проверьте ограничения провайдера`
            },
            setup: {
                title: 'Настройка приложения',
                content: `1. Скачайте приложение из официального магазина\n2. Активируйте профиль через инструкции\n3. Нажмите подключиться\n4. Разрешите VPN соединение`
            },
            billing: {
                title: 'Вопросы по оплате',
                content: `1. Платежи обрабатываются автоматически\n2. При проблемах обратитесь в поддержку\n3. Возврат возможен в течение 7 дней\n4. Проверьте историю платежей в приложении`
            }
        };

        return faqs[type] || { title: 'Помощь', content: 'Информация не найдена' };
    },

    handleEscapeKey(e) {
        if (e.key === 'Escape' && this.isVisible) {
            this.hide();
        }
    },

    hide() {
        if (!this.modal) return;

        this.modal.classList.remove('active');
        setTimeout(() => {
            if (this.modal && this.modal.parentNode) {
                this.modal.parentNode.removeChild(this.modal);
            }
            this.cleanup();
        }, 300);

        this.isVisible = false;
    },

    cleanup() {
        this.modal = null;

        // Убираем обработчик Escape
        document.removeEventListener('keydown', this.handleEscapeKey.bind(this));
    }
};