// Payment API for Dragon VPN Mini App

window.PaymentAPI = {
    /**
     * Создание нового платежа
     * @param {Object} data - Данные платежа
     * @returns {Promise<Object>} Результат создания платежа
     */
    async createPayment(data) {
        // Автоматически добавляем user_id из Telegram
        const telegramUser = window.TelegramApp?.getUserInfo();
        if (telegramUser?.id && !data.user_id) {
            try {
                const user = await window.UserAPI.getUserByTelegramId(telegramUser.id);
                data.user_id = user.user.telegram_id;
            } catch (error) {
                Utils.log('error', 'Could not get user_id for payment');
                throw new Error('Пользователь не найден');
            }
        }

        return await window.APIClient.post('/payment', data);
    },

    /**
     * Получение платежа по ID
     * @param {string} paymentId - UUID платежа
     * @returns {Promise<Object>} Данные платежа
     */
    async getPayment(paymentId) {
        return await window.APIClient.get(`/payment/${paymentId}`);
    },

    /**
     * Обновление платежа
     * @param {string} paymentId - UUID платежа
     * @param {Object} paymentData - Данные для обновления
     * @returns {Promise<Object>} Обновленный платеж
     */
    async updatePayment(paymentId, paymentData) {
        return await window.APIClient.put(`/payment/${paymentId}`, { payment: paymentData });
    },

    /**
     * Получение истории платежей пользователя
     * @param {Object} params - Параметры фильтрации
     * @returns {Promise<Object>} Список платежей
     */
    async listPayments(params = {}) {
        // Автоматически добавляем user_id из Telegram
        const telegramUser = window.TelegramApp?.getUserInfo();
        if (telegramUser?.id && !params.user_id) {
            try {
                const user = await window.UserAPI.getUserByTelegramId(telegramUser.id);
                params.user_id = user.user.telegram_id;
            } catch (error) {
                Utils.log('warn', 'Could not get user for payments filter');
            }
        }

        return await window.APIClient.get('/payments', params);
    },

    /**
     * Получение pending платежей пользователя
     * @returns {Promise<Array>} Список pending платежей
     */
    async getPendingPayments() {
        try {
            const response = await this.listPayments({ status: 'pending' });
            return response.payments || [];
        } catch (error) {
            Utils.log('error', 'Failed to get pending payments:', error);
            return [];
        }
    }
};